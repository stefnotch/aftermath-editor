(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const Be="0.2.5";let a;const Te=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&Te.decode();let V=null;function re(){return(V===null||V.byteLength===0)&&(V=new Uint8Array(a.memory.buffer)),V}function G(r,e){return r=r>>>0,Te.decode(re().subarray(r,r+e))}const B=new Array(128).fill(void 0);B.push(void 0,null,!0,!1);let W=B.length;function h(r){W===B.length&&B.push(B.length+1);const e=W;if(W=B[e],typeof W!="number")throw new Error("corrupt heap");return B[e]=r,e}function c(r){return B[r]}function R(r){if(typeof r!="boolean")throw new Error("expected a boolean argument")}let F=0;const ie=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Ne=typeof ie.encodeInto=="function"?function(r,e){return ie.encodeInto(r,e)}:function(r,e){const t=ie.encode(r);return e.set(t),{read:r.length,written:t.length}};function J(r,e,t){if(typeof r!="string")throw new Error("expected a string argument");if(t===void 0){const d=ie.encode(r),u=e(d.length,1)>>>0;return re().subarray(u,u+d.length).set(d),F=d.length,u}let n=r.length,i=e(n,1)>>>0;const s=re();let o=0;for(;o<n;o++){const d=r.charCodeAt(o);if(d>127)break;s[i+o]=d}if(o!==n){o!==0&&(r=r.slice(o)),i=t(i,n,n=o+r.length*3,1)>>>0;const d=re().subarray(i+o,i+n),u=Ne(r,d);if(u.read!==r.length)throw new Error("failed to pass whole string");o+=u.written}return F=o,i}function $(r){return r==null}let K=null;function m(){return(K===null||K.byteLength===0)&&(K=new Int32Array(a.memory.buffer)),K}function Pe(r){r<132||(B[r]=W,W=r)}function E(r){const e=c(r);return Pe(r),e}function w(r){if(typeof r!="number")throw new Error("expected a number argument")}let X=null;function De(){return(X===null||X.byteLength===0)&&(X=new Float64Array(a.memory.buffer)),X}function _e(r){const e=typeof r;if(e=="number"||e=="boolean"||r==null)return`${r}`;if(e=="string")return`"${r}"`;if(e=="symbol"){const i=r.description;return i==null?"Symbol":`Symbol(${i})`}if(e=="function"){const i=r.name;return typeof i=="string"&&i.length>0?`Function(${i})`:"Function"}if(Array.isArray(r)){const i=r.length;let s="[";i>0&&(s+=_e(r[0]));for(let o=1;o<i;o++)s+=", "+_e(r[o]);return s+="]",s}const t=/\[object ([^\]]+)\]/.exec(toString.call(r));let n;if(t.length>1)n=t[1];else return toString.call(r);if(n=="Object")try{return"Object("+JSON.stringify(r)+")"}catch{return"Object"}return r instanceof Error?`${r.name}: ${r.message}
${r.stack}`:n}function je(r){if(typeof r!="bigint")throw new Error("expected a bigint argument")}let Q=null;function $e(){return(Q===null||Q.byteLength===0)&&(Q=new BigInt64Array(a.memory.buffer)),Q}function S(r,e){if(!(r instanceof e))throw new Error(`expected instance of ${e.name}`);return r.ptr}function _(r,e){try{return r.apply(this,e)}catch(t){let n=function(){try{return t instanceof Error?`${t.message}

Stack:
${t.stack}`:t.toString()}catch{return"<failed to stringify thrown value>"}}();throw console.error("wasm-bindgen: imported JS function that was not marked as `catch` threw an error:",n),t}}function ce(r,e){try{return r.apply(this,e)}catch(t){a.__wbindgen_exn_store(h(t))}}class I{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e=e>>>0;const t=Object.create(I.prototype);return t.__wbg_ptr=e,t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();a.__wbg_boxedparsemodule_free(e)}}class oe{static __wrap(e){e=e>>>0;const t=Object.create(oe.prototype);return t.__wbg_ptr=e,t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();a.__wbg_matheditorbindings_free(e)}constructor(e){if(S(e,Y),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.matheditorbindings_new(e.__wbg_ptr);return oe.__wrap(t)}focus(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr),a.matheditorbindings_focus(this.__wbg_ptr)}unfocus(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr),a.matheditorbindings_unfocus(this.__wbg_ptr)}move_caret(e,t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr),a.matheditorbindings_move_caret(this.__wbg_ptr,h(e),h(t))}select_with_caret(e,t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return w(this.__wbg_ptr),a.matheditorbindings_select_with_caret(this.__wbg_ptr,h(e),h(t))!==0}remove_at_caret(e,t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return w(this.__wbg_ptr),a.matheditorbindings_remove_at_caret(this.__wbg_ptr,h(e),h(t))!==0}insert_at_caret(e){try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");const i=a.__wbindgen_add_to_stack_pointer(-16);w(this.__wbg_ptr),a.matheditorbindings_insert_at_caret(i,this.__wbg_ptr,h(e));var t=m()[i/4+0],n=m()[i/4+1];if(n)throw E(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}select_all(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr),a.matheditorbindings_select_all(this.__wbg_ptr)}undo(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return w(this.__wbg_ptr),a.matheditorbindings_undo(this.__wbg_ptr)!==0}redo(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return w(this.__wbg_ptr),a.matheditorbindings_redo(this.__wbg_ptr)!==0}start_selection(e,t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr),a.matheditorbindings_start_selection(this.__wbg_ptr,h(e),h(t))}extend_selection(e){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr),a.matheditorbindings_extend_selection(this.__wbg_ptr,h(e))}finish_selection(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr),a.matheditorbindings_finish_selection(this.__wbg_ptr)}copy(e){let t,n;try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");const p=a.__wbindgen_add_to_stack_pointer(-16);w(this.__wbg_ptr),a.matheditorbindings_copy(p,this.__wbg_ptr,h(e));var i=m()[p/4+0],s=m()[p/4+1],o=m()[p/4+2],d=m()[p/4+3],u=i,f=s;if(d)throw u=0,f=0,E(o);return t=u,n=f,G(u,f)}finally{a.__wbindgen_add_to_stack_pointer(16),a.__wbindgen_free(t,n,1)}}paste(e,t){try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");const s=a.__wbindgen_add_to_stack_pointer(-16);w(this.__wbg_ptr);const o=J(e,a.__wbindgen_malloc,a.__wbindgen_realloc),d=F;a.matheditorbindings_paste(s,this.__wbg_ptr,o,d,$(t)?0:h(t));var n=m()[s/4+0],i=m()[s/4+1];if(i)throw E(n)}finally{a.__wbindgen_add_to_stack_pointer(16)}}open_autocomplete(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return w(this.__wbg_ptr),a.matheditorbindings_open_autocomplete(this.__wbg_ptr)!==0}finish_autocomplete(e){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return w(this.__wbg_ptr),R(e),a.matheditorbindings_finish_autocomplete(this.__wbg_ptr,e)!==0}move_in_autocomplete(e){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return w(this.__wbg_ptr),a.matheditorbindings_move_in_autocomplete(this.__wbg_ptr,h(e))!==0}get_autocomplete(){try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");const i=a.__wbindgen_add_to_stack_pointer(-16);w(this.__wbg_ptr),a.matheditorbindings_get_autocomplete(i,this.__wbg_ptr);var e=m()[i/4+0],t=m()[i/4+1],n=m()[i/4+2];if(n)throw E(t);return E(e)}finally{a.__wbindgen_add_to_stack_pointer(16)}}get_caret(){try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");const i=a.__wbindgen_add_to_stack_pointer(-16);w(this.__wbg_ptr),a.matheditorbindings_get_caret(i,this.__wbg_ptr);var e=m()[i/4+0],t=m()[i/4+1],n=m()[i/4+2];if(n)throw E(t);return E(e)}finally{a.__wbindgen_add_to_stack_pointer(16)}}get_input_tree(){try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");const i=a.__wbindgen_add_to_stack_pointer(-16);w(this.__wbg_ptr),a.matheditorbindings_get_input_tree(i,this.__wbg_ptr);var e=m()[i/4+0],t=m()[i/4+1],n=m()[i/4+2];if(n)throw E(t);return E(e)}finally{a.__wbindgen_add_to_stack_pointer(16)}}get_syntax_tree(){try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");const i=a.__wbindgen_add_to_stack_pointer(-16);w(this.__wbg_ptr),a.matheditorbindings_get_syntax_tree(i,this.__wbg_ptr);var e=m()[i/4+0],t=m()[i/4+1],n=m()[i/4+2];if(n)throw E(t);return E(e)}finally{a.__wbindgen_add_to_stack_pointer(16)}}splice_at_range(e,t){try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");const s=a.__wbindgen_add_to_stack_pointer(-16);w(this.__wbg_ptr),a.matheditorbindings_splice_at_range(s,this.__wbg_ptr,h(e),h(t));var n=m()[s/4+0],i=m()[s/4+1];if(i)throw E(n)}finally{a.__wbindgen_add_to_stack_pointer(16)}}}class Y{static __wrap(e){e=e>>>0;const t=Object.create(Y.prototype);return t.__wbg_ptr=e,t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();a.__wbg_mathparserbindings_free(e)}constructor(e){if(S(e,Z),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");var t=e.__destroy_into_raw();const n=a.mathparserbindings_new(t);return Y.__wrap(n)}}class Z{static __wrap(e){e=e>>>0;const t=Object.create(Z.prototype);return t.__wbg_ptr=e,t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();a.__wbg_parsemodulecollectionbindings_free(e)}constructor(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulecollectionbindings_new(e.__wbg_ptr);return Z.__wrap(t)}add_module(e){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");if(w(this.__wbg_ptr),S(e,I),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");var t=e.__destroy_into_raw();a.parsemodulecollectionbindings_add_module(this.__wbg_ptr,t)}}class M{static __wrap(e){e=e>>>0;const t=Object.create(M.prototype);return t.__wbg_ptr=e,t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();a.__wbg_parsemodulesbindings_free(e)}constructor(){const e=a.parsemodulesbindings_new();return M.__wrap(e)}get_built_in(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr);const e=a.parsemodulesbindings_get_built_in(this.__wbg_ptr);return I.__wrap(e)}get_syntax_node_name_map(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");w(this.__wbg_ptr);const e=a.parsemodulesbindings_get_syntax_node_name_map(this.__wbg_ptr);return E(e)}}class P{constructor(){throw new Error("cannot invoke `new` directly")}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();a.__wbg_parsemodulescreator_free(e)}static make_core(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulescreator_make_core(e.__wbg_ptr);return I.__wrap(t)}static make_arithmetic(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulescreator_make_arithmetic(e.__wbg_ptr);return I.__wrap(t)}static make_calculus(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulescreator_make_calculus(e.__wbg_ptr);return I.__wrap(t)}static make_collections(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulescreator_make_collections(e.__wbg_ptr);return I.__wrap(t)}static make_comparison(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulescreator_make_comparison(e.__wbg_ptr);return I.__wrap(t)}static make_function(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulescreator_make_function(e.__wbg_ptr);return I.__wrap(t)}static make_logic(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulescreator_make_logic(e.__wbg_ptr);return I.__wrap(t)}static make_string(e){if(S(e,M),e.__wbg_ptr===0)throw new Error("Attempt to use a moved value");const t=a.parsemodulescreator_make_string(e.__wbg_ptr);return I.__wrap(t)}}async function ze(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(n){if(r.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const t=await r.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(r,e);return t instanceof WebAssembly.Instance?{instance:t,module:r}:t}}function He(){const r={};return r.wbg={},r.wbg.__wbindgen_error_new=function(e,t){const n=new Error(G(e,t));return h(n)},r.wbg.__wbindgen_is_undefined=function(e){const t=c(e)===void 0;return R(t),t},r.wbg.__wbindgen_as_number=function(e){return+c(e)},r.wbg.__wbindgen_in=function(e,t){const n=c(e)in c(t);return R(n),n},r.wbg.__wbindgen_string_new=function(e,t){const n=G(e,t);return h(n)},r.wbg.__wbindgen_string_get=function(e,t){const n=c(t),i=typeof n=="string"?n:void 0;var s=$(i)?0:J(i,a.__wbindgen_malloc,a.__wbindgen_realloc),o=F;m()[e/4+1]=o,m()[e/4+0]=s},r.wbg.__wbindgen_is_bigint=function(e){const t=typeof c(e)=="bigint";return R(t),t},r.wbg.__wbindgen_is_object=function(e){const t=c(e),n=typeof t=="object"&&t!==null;return R(n),n},r.wbg.__wbindgen_is_string=function(e){const t=typeof c(e)=="string";return R(t),t},r.wbg.__wbindgen_object_clone_ref=function(e){const t=c(e);return h(t)},r.wbg.__wbindgen_jsval_eq=function(e,t){const n=c(e)===c(t);return R(n),n},r.wbg.__wbindgen_bigint_from_u64=function(e){const t=BigInt.asUintN(64,e);return h(t)},r.wbg.__wbg_debug_9b8701f894da9929=function(){return _(function(e,t,n,i){console.debug(c(e),c(t),c(n),c(i))},arguments)},r.wbg.__wbg_error_d9bce418caafb712=function(){return _(function(e,t,n,i){console.error(c(e),c(t),c(n),c(i))},arguments)},r.wbg.__wbg_info_bb52f40b06f679de=function(){return _(function(e,t,n,i){console.info(c(e),c(t),c(n),c(i))},arguments)},r.wbg.__wbg_log_ea7093e35e3efd07=function(){return _(function(e,t,n,i){console.log(c(e),c(t),c(n),c(i))},arguments)},r.wbg.__wbg_warn_dfc0e0cf544a13bd=function(){return _(function(e,t,n,i){console.warn(c(e),c(t),c(n),c(i))},arguments)},r.wbg.__wbindgen_object_drop_ref=function(e){E(e)},r.wbg.__wbg_error_f851667af71bcfc6=function(){return _(function(e,t){let n,i;try{n=e,i=t,console.error(G(e,t))}finally{a.__wbindgen_free(n,i,1)}},arguments)},r.wbg.__wbg_new_abda76e883ba8a5f=function(){return _(function(){const e=new Error;return h(e)},arguments)},r.wbg.__wbg_stack_658279fe44541cf6=function(){return _(function(e,t){const n=c(t).stack,i=J(n,a.__wbindgen_malloc,a.__wbindgen_realloc),s=F;m()[e/4+1]=s,m()[e/4+0]=i},arguments)},r.wbg.__wbindgen_number_get=function(e,t){const n=c(t),i=typeof n=="number"?n:void 0;$(i)||w(i),De()[e/8+1]=$(i)?0:i,m()[e/4+0]=!$(i)},r.wbg.__wbindgen_boolean_get=function(e){const t=c(e),n=typeof t=="boolean"?t?1:0:2;return w(n),n},r.wbg.__wbindgen_number_new=function(e){return h(e)},r.wbg.__wbindgen_jsval_loose_eq=function(e,t){const n=c(e)==c(t);return R(n),n},r.wbg.__wbg_getwithrefkey_d1f0d12f1f1b63ea=function(){return _(function(e,t){const n=c(e)[c(t)];return h(n)},arguments)},r.wbg.__wbg_set_bd72c078edfa51ad=function(){return _(function(e,t,n){c(e)[E(t)]=E(n)},arguments)},r.wbg.__wbg_String_88810dfeb4021902=function(){return _(function(e,t){const n=String(c(t)),i=J(n,a.__wbindgen_malloc,a.__wbindgen_realloc),s=F;m()[e/4+1]=s,m()[e/4+0]=i},arguments)},r.wbg.__wbg_getwithrefkey_5e6d9547403deab8=function(){return _(function(e,t){const n=c(e)[c(t)];return h(n)},arguments)},r.wbg.__wbg_set_841ac57cff3d672b=function(){return _(function(e,t,n){c(e)[E(t)]=E(n)},arguments)},r.wbg.__wbg_new_898a68150f225f2e=function(){return _(function(){const e=new Array;return h(e)},arguments)},r.wbg.__wbg_get_44be0491f933a435=function(){return _(function(e,t){const n=c(e)[t>>>0];return h(n)},arguments)},r.wbg.__wbg_set_502d29070ea18557=function(){return _(function(e,t,n){c(e)[t>>>0]=E(n)},arguments)},r.wbg.__wbg_isArray_4c24b343cb13cfb1=function(){return _(function(e){const t=Array.isArray(c(e));return R(t),t},arguments)},r.wbg.__wbg_length_fff51ee6522a1a18=function(){return _(function(e){const t=c(e).length;return w(t),t},arguments)},r.wbg.__wbg_instanceof_ArrayBuffer_39ac22089b74fddb=function(){return _(function(e){let t;try{t=c(e)instanceof ArrayBuffer}catch{t=!1}const n=t;return R(n),n},arguments)},r.wbg.__wbg_call_cb65541d95d71282=function(){return ce(function(e,t){const n=c(e).call(c(t));return h(n)},arguments)},r.wbg.__wbg_new_56693dbed0c32988=function(){return _(function(){return h(new Map)},arguments)},r.wbg.__wbg_set_bedc3d02d0f05eb0=function(){return _(function(e,t,n){const i=c(e).set(c(t),c(n));return h(i)},arguments)},r.wbg.__wbg_next_ddb3312ca1c4e32a=function(){return ce(function(e){const t=c(e).next();return h(t)},arguments)},r.wbg.__wbg_next_526fc47e980da008=function(){return _(function(e){const t=c(e).next;return h(t)},arguments)},r.wbg.__wbg_done_5c1f01fb660d73b5=function(){return _(function(e){const t=c(e).done;return R(t),t},arguments)},r.wbg.__wbg_value_1695675138684bd5=function(){return _(function(e){const t=c(e).value;return h(t)},arguments)},r.wbg.__wbg_isSafeInteger_bb8e18dd21c97288=function(){return _(function(e){const t=Number.isSafeInteger(c(e));return R(t),t},arguments)},r.wbg.__wbg_entries_e51f29c7bba0c054=function(){return _(function(e){const t=Object.entries(c(e));return h(t)},arguments)},r.wbg.__wbg_new_b51585de1b234aff=function(){return _(function(){const e=new Object;return h(e)},arguments)},r.wbg.__wbg_iterator_97f0c81209c6c35a=function(){return _(function(){return h(Symbol.iterator)},arguments)},r.wbg.__wbg_instanceof_Uint8Array_d8d9cb2b8e8ac1d4=function(){return _(function(e){let t;try{t=c(e)instanceof Uint8Array}catch{t=!1}const n=t;return R(n),n},arguments)},r.wbg.__wbg_new_8125e318e6245eed=function(){return _(function(e){const t=new Uint8Array(c(e));return h(t)},arguments)},r.wbg.__wbg_length_72e2208bbc0efc61=function(){return _(function(e){const t=c(e).length;return w(t),t},arguments)},r.wbg.__wbg_set_5cf90238115182c3=function(){return _(function(e,t,n){c(e).set(c(t),n>>>0)},arguments)},r.wbg.__wbg_buffer_085ec1f694018c4f=function(){return _(function(e){const t=c(e).buffer;return h(t)},arguments)},r.wbg.__wbg_get_97b561fb56f034b5=function(){return ce(function(e,t){const n=Reflect.get(c(e),c(t));return h(n)},arguments)},r.wbg.__wbindgen_is_function=function(e){const t=typeof c(e)=="function";return R(t),t},r.wbg.__wbindgen_debug_string=function(e,t){const n=_e(c(t)),i=J(n,a.__wbindgen_malloc,a.__wbindgen_realloc),s=F;m()[e/4+1]=s,m()[e/4+0]=i},r.wbg.__wbindgen_bigint_get_as_i64=function(e,t){const n=c(t),i=typeof n=="bigint"?n:void 0;$(i)||je(i),$e()[e/8+1]=$(i)?BigInt(0):i,m()[e/4+0]=!$(i)},r.wbg.__wbindgen_throw=function(e,t){throw new Error(G(e,t))},r.wbg.__wbindgen_memory=function(){const e=a.memory;return h(e)},r}function qe(r,e){return a=r.exports,Ae.__wbindgen_wasm_module=e,Q=null,X=null,K=null,V=null,a.__wbindgen_start(),a}async function Ae(r){if(a!==void 0)return a;typeof r>"u"&&(r=new URL("/aftermath-editor/assets/aftermath_core_bg-635ead5e.wasm",self.location));const e=He();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:n}=await ze(await r,e);return qe(t,n)}function Fe(r,e){return[new Error(r),e]}function l(r,e){if(!r)throw new Error(e)}function Ue(r){throw Fe("Unreachable value",{value:r})}await Ae();const k=new M,D={BuiltIn:k.get_built_in(),Core:P.make_core(k),Arithmetic:P.make_arithmetic(k),Calculus:P.make_calculus(k),Collections:P.make_collections(k),Comparison:P.make_comparison(k),Function:P.make_function(k),Logic:P.make_logic(k),String:P.make_string(k)};function We(r){const e=new Z(k);for(let t of r)e.add_module(t);return new Y(e)}const U={insertAtCaret(r,e){return r.insert_at_caret(e)},paste(r,e,t){return r.paste(e,t)},getCaret(r){return r.get_caret()},getAutocomplete(r){return r.get_autocomplete()},getInputTree(r){return r.get_input_tree()},getSyntaxTree(r){return r.get_syntax_tree()},spliceAtRange(r,e,t){return r.splice_at_range(e,t)}},Ve=We([D.Core,D.Arithmetic,D.Calculus,D.Collections,D.Comparison,D.Function,D.Logic,D.String]);function ge(r){return!Array.isArray(r)&&"values"in r?(l(!0),!0):!1}function g(r,e){return e in r.children}function ae(r,e){return e.start<=r&&r<=e.end}function Ge(r){l(y(r,"math"));const e=[],t=b(r,e);return l(ge(t)),{root:t,errors:e}}function L(r){return{Symbol:r.normalize("NFD")}}function Je(r){return{Container:["Fraction",{values:r,width:1}]}}function Ee(r){return{Container:["Root",{values:r,width:2}]}}function te(r){return{Container:["Sup",{values:[r],width:1}]}}function ne(r){return{Container:["Sub",{values:[r],width:1}]}}function Ke(r,e){return{Container:["Table",{values:r,width:e}]}}function b(r,e){let t=[...r.children];if(y(r,"math","mrow","mtd"))return C(t.flatMap(n=>b(n,e)));if(y(r,"semantics")&&t.length>0)return b(t[0],e);if(y(r,"mtext","ms"))return[L('"'),...se(de(r)).map(n=>L(n)),L('"')];if(y(r,"mi","mn"))return se(de(r)).map(n=>L(n));if(y(r,"mo"))return se(de(r)).map(n=>L(n));if(y(r,"mfrac"))return j(r,2,e)??Je(t.map(n=>C(b(n,e))));if(y(r,"msqrt"))return Ee([C(L("2")),C(t.flatMap(n=>b(n,e)))]);if(y(r,"mroot"))return j(r,2,e)??Ee([C(b(t[1],e)),C(b(t[0],e))]);if(y(r,"msub")){let n=b(t[0],e);return Array.isArray(n)||(n=[n]),j(r,2,e)??[...n,ne(C(b(t[1],e)))]}else if(y(r,"msup")){let n=b(t[0],e);return Array.isArray(n)||(n=[n]),j(r,2,e)??[...n,te(C(b(t[1],e)))]}else if(y(r,"msubsup")){let n=b(t[0],e);return Array.isArray(n)||(n=[n]),j(r,3,e)??[...n,ne(C(b(t[1],e))),te(C(b(t[2],e)))]}else{if(y(r,"munder"))return j(r,2,e)??[...C(b(t[0],e)).values,ne(C(b(t[1],e)))];if(y(r,"mover"))return j(r,2,e)??[...C(b(t[0],e)).values,te(C(b(t[1],e)))];if(y(r,"munderover"))return j(r,3,e)??[...C(b(t[0],e)).values,ne(C(b(t[1],e))),te(C(b(t[2],e)))];if(y(r,"mtable")){if(!t.every(s=>y(s,"mtr")&&[...s.children].every(o=>y(o,"mtd"))))return e.push(new Error("Unexpected children "+r)),L("Error");const n=t.map(s=>s.children.length).reduce((s,o)=>Math.max(s,o),0),i=t.flatMap(s=>Array.from({length:n},(o,d)=>d<s.children.length?C(b(s.children[d],e)):{values:[]}));return Ke(i,n)}else return y(r,"mstyle")?[]:(e.push(new Error("Unknown element "+r.tagName)),L("Error"))}}function j(r,e,t){return r.children.length!=e?(t.push(new Error(`Expected ${e} children in ${r.tagName.toLowerCase()}`)),L("Error")):null}function de(r){return(r.textContent+"").trim()}const Ce=globalThis?.Intl?.Segmenter?new Intl.Segmenter("en",{granularity:"grapheme"}):null;function se(r){return Ce?Array.from(Ce.segment(r),({segment:e})=>e):[...r]}function y(r,...e){return e.includes(r.tagName.toLowerCase())}function C(r){if(r==null)return{values:[]};if(!Array.isArray(r)){if(ge(r))return r;r=[r]}return{values:r.flatMap(e=>ge(e)?e.values:e)}}const Xe=`.caret-container-highlight{background-color:#f2f2f2;border-radius:3px}.caret-selection{background-color:#1895f558;border-radius:3px;pointer-events:none}.caret-token-highlighter{pointer-events:none;position:absolute;border-bottom:1px solid #21212189}.caret{user-select:none;position:absolute;height:10px;width:0px;margin:0;border-right-width:0px;box-shadow:0 0 0 .5px #3232e67f;top:0}
`,Qe=`:host{display:inline}math{display:inline;font-family:math,STIX Two;white-space:nowrap}mroot>:first-child:after{content:"";width:2px;height:10px;position:absolute}mtd{display:table-cell;text-align:center;padding:.5ex .4em}.row-debug{border-radius:8px;box-shadow:0 1px #ff00006c}merror{font-weight:initial;font-size:initial;font-family:inherit;margin:0;padding:0}.red-squiggly{border-bottom:1px solid red;border-bottom-style:dotted}
`,Ye=`.math-input-area{transform:scale(0);resize:none;position:absolute;clip-path:polygon(0 0);width:0px;height:0px}
`,Ze=`.autocomplete-container ul{margin:0;padding:0;list-style:none;text-align:left;font-family:Courier New,Courier,monospace;color:#000}.autocomplete-container{min-width:100px;min-height:20px;border:1px solid rgb(69,69,69);background:rgba(211,211,211,.857)}
`;function et(r){const e=document.createElement("template");return e.innerHTML=r,e.content.firstElementChild}function z(r,e,t=[]){const n=document.createElement(r);return Object.entries(e).forEach(([i,s])=>{i==="classList"?s.forEach(o=>{n.classList.add(o)}):i==="style"?Object.entries(s).forEach(([o,d])=>{n.style[o]=d}):i==="attributes"?Object.entries(s).forEach(([o,d])=>{n.setAttribute(o,d)}):n[i]=s}),n.append(...t),n}class tt{#e;constructor(){const e=z("textarea",{classList:["input-textarea","math-input-area"],autocomplete:"off",spellcheck:!1,attributes:{autocorrect:"off"}});this.#e=e}focus(){this.#e.focus()}get element(){return this.#e}}class N{indices;constructor(e){this.indices=e}static default(){return new N([])}addRowIndex(e){return e===null?this:new N(this.indices.concat([e]))}get length(){return this.indices.length}[Symbol.iterator](){let e=0;return{next:()=>e>=this.indices.length?{done:!0,value:void 0}:{done:!1,value:this.indices[e++]}}}}const O={joinRectangles:(r,e)=>{const t=Math.min(r.y,e.y),n=Math.min(r.x,e.x),i=Math.max(r.y+r.height,e.y+e.height),s=Math.max(r.x+r.width,e.x+e.width);return{x:n,y:t,width:s-n,height:i-t}},distanceToRectangle:(r,e)=>{const t=Math.max(e.x-r.x,r.x-(e.x+e.width)),n=Math.max(e.y-r.y,r.y-(e.y+e.height));return Math.sqrt(Math.max(0,t)**2+Math.max(0,n)**2)},distanceToPoint:(r,e)=>Math.hypot(e.x-r.x,e.y-r.y),distanceToPointSquared:(r,e)=>(r.x-e.x)**2+(r.y-e.y)**2,distanceToSegmentSquared:(r,e)=>{const{a:t,b:n}=e,i=1e-5,s=O.distanceToPointSquared(t,n);if(s<i)return O.distanceToPointSquared(r,t);let o=((r.x-t.x)*(n.x-t.x)+(r.y-t.y)*(n.y-t.y))/s;return o=Math.max(0,Math.min(1,o)),O.distanceToPointSquared(r,{x:t.x+o*(n.x-t.x),y:t.y+o*(n.y-t.y)})},distanceToSegment:(r,e)=>Math.sqrt(O.distanceToSegmentSquared(r,e))};class we{#e;#t;constructor(e,t){this.#e=e,this.#t=t}get rect(){return this.#e}get baseline(){return this.#t}get isCollapsed(){return this.#e.width===0}join(e){return l(Math.abs(this.baseline-e.baseline)<5,"Can't join selections with different baselines"),new we(O.joinRectangles(this.rect,e.rect),this.baseline)}}class nt{rootElement;constructor(e){this.rootElement=e}getViewportSelection(e){const t=this.getElement(e.indices),n=t.getCaretPosition(0).y,i=e.start<=e.end,s=i?e.start:e.end,o=i?e.end:e.start,d={top:1/0,bottom:-1/0};function u(T){const pe=o<=T.syntaxTree.range.start||T.syntaxTree.range.end<=s;if(pe)return d;const Oe=s<=T.syntaxTree.range.start&&T.syntaxTree.range.end<=o,Le=!pe&&!Oe,be=T.getChildren();if(Le&&be.length>0)return be.map(ee=>u(ee)).reduce((ee,ye)=>({top:Math.min(ee.top,ye.top),bottom:Math.max(ee.bottom,ye.bottom)}),d);const le=T.getBounds();return{top:le.y,bottom:le.y+le.height}}const f=t.getCaretPosition(e.start),p=t.getCaretPosition(e.end),v=e.start!==e.end?u(t):{top:f.y,bottom:f.y};return new we({x:i?f.x:p.x,y:v.top,width:Math.abs(p.x-f.x),height:v.bottom-v.top},n)}getViewportRowBounds(e){return this.getElement(e).getBounds()}getViewportCaretSize(e){return this.getElement(e).getCaretSize()}getElement(e){let t=this.rootElement;for(let n of e){let[i,s]=n;l(t.syntaxTree.range.start<=i&&i<t.syntaxTree.range.end);const o=Me(t,i),d=o.getChildren().find(u=>u.rowIndex?.[1]===s);l(d,`Couldn't find row ${s} in ${o.syntaxTree.name}`),t=d}return t}getLayoutElement(e){function t(n,i){if(O.distanceToRectangle(e,n.getBounds())>0)return null;for(const s of n.getChildren()){const o=t(s,i.addRowIndex(s.rowIndex));if(o)return o}return{element:n,indices:i}}return t(this.rootElement,N.default())??{element:this.rootElement,indices:N.default()}}getLayoutPosition(e){let n=[this.getLayoutElement(e)],i={indicesAndOffset:null,distance:1/0};for(;n.length>0;){const d=n.pop();l(d!==void 0);const{element:u,indices:f}=d;if(O.distanceToRectangle(e,u.getBounds())>i.distance)continue;const p=s(u,e);if(p===null)continue;const v={indicesAndOffset:{indices:f,offset:p.offset},distance:O.distanceToPoint(e,p.position)};v.distance<i.distance&&(i=v),o(u).forEach(T=>{l(T.rowIndex!==null),n.push({element:T,indices:f.addRowIndex(T.rowIndex)})})}function s(d,u){let f={renderedPosition:null,distance:1/0};for(let p=d.syntaxTree.range.start;p<=d.syntaxTree.range.end;p++){const v=d.getCaretPosition(p),T=O.distanceToPoint(u,v);T<f.distance&&(f={renderedPosition:{position:v,offset:p},distance:T})}return f.renderedPosition}function o(d){return d.getChildren().flatMap(u=>u.rowIndex?u:o(u))}return l(i.indicesAndOffset!==null),i.indicesAndOffset}}function Me(r,e){if(g(r.syntaxTree,"Children")){for(let t of r.getChildren())if(t.syntaxTree.range.start<=e&&e<t.syntaxTree.range.end)return Me(t,e)}return r}const ue={math:null,semantics:"TODO:",annotation:"TODO:","annotation-xml":"TODO:",mtext:"TODO:",mi:"TODO:",mn:"TODO:",mo:"TODO:",mspace:"TODO:",ms:"TODO:",mrow:null,mfrac:2,msqrt:"TODO:",mroot:2,mstyle:"TODO:",merror:null,maction:"TODO:",mpadded:"TODO:",mphantom:"TODO:",msub:2,msup:2,msubsup:"TODO:",munder:2,mover:2,munderover:"TODO:",mmultiscripts:"TODO:",none:"TODO:",mprescripts:"TODO:",mtable:null,mtr:null,mtd:null},Se=[["(",")"],["[","]"],["{","}"],["⌈","⌉"],["⌊","⌋"],["〈","〉"],["❲","❳"],["⟦","⟧"],["⟨","⟩"],["⟪","⟫"],["⟬","⟭"],["⟮","⟯"],["⦃","⦄"],["⦅","⦆"],["⦇","⦈"],["⦉","⦊"],["⦋","⦌"],["⦍","⦎"],["⦏","⦐"],["⦑","⦒"],["⦓","⦔"],["⦕","⦖"],["⦗","⦘"],["⧘","⧙"],["⧚","⧛"],["⧼","⧽"]],rt=[["|","|"],["‖","‖"],["⦀","⦀"],["⦙","⦙"]];new Map(Se);new Map(rt);new Map(Se.map(([r,e])=>[e,r]));class H{element;children=[];constructor(e){this.element=e,l(this.elementName in ue,"Unknown element name: "+this.elementName)}getBounds(){return st(this.element)}getElements(){return[this.element]}getCaretSize(){return ot(this.element)}get elementName(){return this.element.tagName.toLowerCase()}setChildren(e){this.setChildrenCustom(e,e.map(t=>fe(t.getElements())))}setChildrenCustom(e,t){l(ue[this.elementName]===null||ue[this.elementName]===e.length,"Invalid number of children for "+this.elementName),this.children=e,this.element.append(...t)}getChildren(){return this.children}}const it="http://www.w3.org/1998/Math/MathML";function x(r,e){const t=document.createElementNS(it,r);return e.forEach(n=>{t.appendChild(n)}),t}function fe(r){return r.length==1?r[0]:x("mrow",r)}function Ie(){return document.createTextNode("⬚")}function st(r){const e=r.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height}}function ot(r){const e=+globalThis.getComputedStyle(r).getPropertyValue("font-size").replace("px","");return l(!isNaN(e)&&e>0),e}class A{constructor(e,t,n,i,s={}){this.syntaxTree=e,this.rowIndex=t,l(e.children.Children.length>0,"Needs at least one child"),this.element=new H(x(n,[])),this.element.setChildren(e.children.Children.map(o=>i.render(o,null,s))),l(this.element.getChildren().length===this.syntaxTree.children.Children.length,"Invalid number of children"),l(this.element.getChildren().length>0,"Needs at least one rendered child")}element;getCaretSize(){return this.element.getCaretSize()}getBounds(){return this.element.getBounds()}getCaretPosition(e){l(this.syntaxTree.range.start<=e&&e<=this.syntaxTree.range.end,"Invalid offset");const t=this.element.getChildren().find(n=>n.syntaxTree.range.start<=e&&e<=n.syntaxTree.range.end);if(t)return t.getCaretPosition(e);throw new Error("Should not happen")}getElements(){return this.element.getElements()}getChildren(){return this.element.getChildren()}}class at{constructor(e,t){this.syntaxTree=e,this.rowIndex=t,l(e.children.Children.length===0),l(e.range.start===e.range.end),this.element=new H(x("mi",[document.createTextNode("  ")])),this.element.element.classList.add("red-squiggly")}element;getCaretSize(){return this.element.getCaretSize()}getBounds(){return this.element.getBounds()}getCaretPosition(e){l(e===this.syntaxTree.range.start);const t=this.element.element.getBoundingClientRect(),n=(t.left+t.right)/2,i=t.bottom;return{x:n,y:i}}getElements(){return this.element.getElements()}getChildren(){return this.element.getChildren()}}class lt{constructor(e,t){this.syntaxTree=e,this.rowIndex=t,l(e.children.Children.length===0),l(e.range.start===e.range.end),this.element=new H(x("mi",[Ie()]))}element;getCaretSize(){return this.element.getCaretSize()}getBounds(){return this.element.getBounds()}getCaretPosition(e){l(e===this.syntaxTree.range.start);const t=this.element.element.getBoundingClientRect(),n=(t.left+t.right)/2,i=t.bottom;return{x:n,y:i}}getElements(){return this.element.getElements()}getChildren(){return this.element.getChildren()}}class ct{constructor(e,t,n,i){this.syntaxTree=e,this.rowIndex=t,l(e.children.NewRows.values.length>0,"Needs at least one child"),this.element=new H(x(n,[])),this.startBaselineReader=x("mphantom",[]),this.endBaselineReader=x("mphantom",[]);const s=this.syntaxTree.range.start;l(this.syntaxTree.range.start+1===this.syntaxTree.range.end,"Invalid range for a row container");const o=e.children.NewRows.values.map((d,u)=>i.render(d,[s,u]));this.element.setChildrenCustom(o,o.slice().reverse().map(d=>fe(d.getElements()))),l(this.element.getChildren().length===this.syntaxTree.children.NewRows.values.length,"Invalid number of children"),l(this.element.getChildren().length>0,"Needs at least one rendered child")}element;startBaselineReader;endBaselineReader;getCaretSize(){return this.element.getCaretSize()}getBounds(){return this.element.getBounds()}getCaretPosition(e){l(this.syntaxTree.range.start<=e&&e<=this.syntaxTree.range.end,"Invalid offset");let t;if(e==this.syntaxTree.range.start)t=this.startBaselineReader;else if(e==this.syntaxTree.range.end)t=this.endBaselineReader;else throw new Error("Don't know how to deal with this offset");let{x:n,y:i}=t.getBoundingClientRect();return{x:n,y:i}}getElements(){return[this.startBaselineReader,this.element.element,this.endBaselineReader]}getChildren(){return this.element.getChildren()}}class he{constructor(e,t,n,i){this.syntaxTree=e,this.rowIndex=t,l(e.children.NewRows.values.length>0,"Needs at least one child"),this.element=new H(x(n,[])),this.startBaselineReader=x("mphantom",[]),this.endBaselineReader=x("mphantom",[]);const s=this.syntaxTree.range.start;l(this.syntaxTree.range.start+1===this.syntaxTree.range.end,"Invalid range for a row container"),this.element.setChildren(e.children.NewRows.values.map((o,d)=>i.render(o,[s,d]))),l(this.element.getChildren().length===this.syntaxTree.children.NewRows.values.length,"Invalid number of children"),l(this.element.getChildren().length>0,"Needs at least one rendered child")}element;startBaselineReader;endBaselineReader;getCaretSize(){return this.element.getCaretSize()}getBounds(){return this.element.getBounds()}getCaretPosition(e){l(this.syntaxTree.range.start<=e&&e<=this.syntaxTree.range.end,"Invalid offset");let t;if(e==this.syntaxTree.range.start)t=this.startBaselineReader;else if(e==this.syntaxTree.range.end)t=this.endBaselineReader;else throw new Error("Don't know how to deal with this offset");let{x:n,y:i}=t.getBoundingClientRect();return{x:n,y:i}}getElements(){return[this.startBaselineReader,this.element.element,this.endBaselineReader]}getChildren(){return this.element.getChildren()}}class ke{constructor(e,t){this.syntaxTree=e,this.range=t,this.textElements=e.symbols.map(n=>document.createTextNode(n))??[Ie()]}textElements;getViewportXPosition(e){l(ae(e,this.range),"Invalid offset");const{graphemeText:t,atEnd:n}=this.getTextNodeAt(e),i=xe(t);return{x:i.x+(n?i.width:0)}}getTextNodeAt(e){const t=e-this.range.start,n=t>=this.textElements.length;return{graphemeText:this.textElements[n?this.textElements.length-1:t],atEnd:n}}getBaseline(e){l(ae(e,this.range),"Invalid offset");const{graphemeText:t}=this.getTextNodeAt(e);return{y:xe(t).bottom}}getElements(){return this.textElements}}function xe(r){l(r.isConnected);const e=document.createRange();return e.selectNode(r),e.getBoundingClientRect()}class dt{constructor(e,t,n,i={}){this.syntaxTree=e,this.rowIndex=t,this.textElement=new ke(e.children.Leaf,e.range);let s=this.textElement.getElements();const o=x(n,s);o.style.whiteSpace="nowrap",i.isStretchy&&o.setAttribute("stretchy","true"),this.element=new H(o)}element;textElement;getCaretSize(){return this.element.getCaretSize()}getBounds(){return this.element.getBounds()}getCaretPosition(e){l(ae(e,this.syntaxTree.range),"Invalid offset");const t=this.element.element.getBoundingClientRect();let n;e<=this.syntaxTree.range.start?n=t.left:e>=this.syntaxTree.range.end?n=t.right:n=this.textElement.getViewportXPosition(e).x;const i=t.bottom;return{x:n,y:i}}getElements(){return this.element.getElements()}getChildren(){return this.element.getChildren()}}class ut{constructor(e,t,n){this.syntaxTree=e,this.rowIndex=t,l(e.children.NewRows.values.length>0,"Needs at least one child"),this.element=new H(x("mtable",[])),this.startBaselineReader=x("mphantom",[]),this.endBaselineReader=x("mphantom",[]);const i=this.syntaxTree.range.start;l(this.syntaxTree.range.start+1===this.syntaxTree.range.end,"Invalid range for a row container");const s=e.children.NewRows.values.map((u,f)=>n.render(u,[i,f])),o=e.children.NewRows.width,d=[];for(let u=0;u<s.length;u+=o){const f=s.slice(u,u+o);d.push(x("mtr",f.map(p=>x("mtd",[fe(p.getElements())]))))}this.element.setChildrenCustom(s,d),l(d.length===Math.floor(this.syntaxTree.children.NewRows.values.length/this.syntaxTree.children.NewRows.width),"Invalid number of children"),l(this.element.getChildren().length===this.syntaxTree.children.NewRows.values.length,"Invalid number of children"),l(this.element.getChildren().length>0,"Needs at least one rendered child")}element;startBaselineReader;endBaselineReader;getCaretSize(){return this.element.getCaretSize()}getBounds(){return this.element.getBounds()}getCaretPosition(e){l(this.syntaxTree.range.start<=e&&e<=this.syntaxTree.range.end,"Invalid offset");let t;if(e==this.syntaxTree.range.start)t=this.startBaselineReader;else if(e==this.syntaxTree.range.end)t=this.endBaselineReader;else throw new Error("Don't know how to deal with this offset");let{x:n,y:i}=t.getBoundingClientRect();return{x:n,y:i}}getElements(){return[this.startBaselineReader,this.element.element,this.endBaselineReader]}getChildren(){return this.element.getChildren()}}class q{constructor(e,t,n){this.syntaxTree=e,this.rowIndex=t,this.textElement=new ke(e.children.Leaf,e.range);let i=this.textElement.getElements();this.element=new H(x(n,i))}element;textElement;getCaretSize(){return this.element.getCaretSize()}getBounds(){return this.element.getBounds()}getCaretPosition(e){l(ae(e,this.syntaxTree.range),"Invalid offset");const t=this.element.element.getBoundingClientRect();let n;e<=this.syntaxTree.range.start?n=t.left:e>=this.syntaxTree.range.end?n=t.right:n=this.textElement.getViewportXPosition(e).x;const i=this.textElement.getBaseline(e).y;return{x:n,y:i}}getElements(){return this.element.getElements()}getChildren(){return this.element.getChildren()}}function me(r){return r.join("::")}class ht{renderers=new Map;nameMap;constructor(e){this.nameMap=e;{const t=this.rendererCollection("BuiltIn");t.add("Nothing",(n,i)=>(l(g(n,"Children")),new lt(n,i))),t.add("Whitespace",(n,i)=>(l(g(n,"Leaf")),new q(n,i,"mspace"))),t.add("Whitespaces",(n,i,s)=>(l(g(n,"Children")),new A(n,i,"mrow",this,s))),t.add("Operator",(n,i,s)=>g(n,"Leaf")?new dt(n,i,"mo",{isStretchy:s.stretchyOperators??!1}):g(n,"Children")?new A(n,i,"mrow",this):(l(g(n,"NewRows")),l(s.newRowsOperatorOverride,"Operator has neither children nor leaf. This means that it's a NewRows operator, like a superscript. Those need have a newRowsOperatorOverride"),s.newRowsOperatorOverride(n,i))),t.add("Fraction",(n,i)=>(l(g(n,"NewRows")),new he(n,i,"mfrac",this))),t.add("Sup",(n,i)=>(l(g(n,"Children")),l(g(n.children.Children[1],"NewRows")),new A(n,i,"msup",this,{newRowsOperatorOverride:s=>(l(g(s,"NewRows")),new he(s,i,"mrow",this))}))),t.add("Sub",(n,i)=>(l(g(n,"Children")),l(g(n.children.Children[1],"NewRows")),new A(n,i,"msub",this,{newRowsOperatorOverride:s=>(l(g(s,"NewRows")),new he(s,i,"mrow",this))}))),t.add("Root",(n,i)=>(l(g(n,"NewRows")),new ct(n,i,"mroot",this))),t.add("Table",(n,i)=>(l(g(n,"NewRows")),new ut(n,i,this)))}{const t=this.rendererCollection("Error");t.add("MissingToken",(n,i)=>(l(g(n,"Children")),new at(n,i))),t.add("UnknownToken",(n,i)=>(l(g(n,"Leaf")),new q(n,i,"merror"))),t.add("MissingOperator",(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this)))}{const t=this.rendererCollection("Core");t.add("Variable",(n,i)=>(l(g(n,"Leaf")),new q(n,i,"mi"))),t.add("RoundBrackets",(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this,{stretchyOperators:!0})))}{const t=this.rendererCollection("Arithmetic");t.add("Number",(n,i)=>(l(g(n,"Leaf")),new q(n,i,"mn"))),t.add(["Add","Subtract","Multiply","Divide","Exponent","Factorial"],(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this)))}{const t=this.rendererCollection("Calculus");t.add(["Infinity"],(n,i)=>(l(g(n,"Leaf")),new q(n,i,"mi"))),t.add(["Lim","LimSup","LimInf"],(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this))),t.add(["Integral","Sum"],(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this)))}this.rendererCollection("Comparison").add(["Equals","GreaterThan","LessThan","GreaterThanOrEquals","LessThanOrEquals"],(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this))),this.rendererCollection("Collections").add("Tuple",(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this))),this.rendererCollection("Function").add("FunctionApplication",(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this))),this.rendererCollection("String").add("String",(n,i)=>(l(g(n,"Leaf")),new q(n,i,"mtext")));{const t=this.rendererCollection("Logic");t.add(["True","False"],(n,i)=>(l(g(n,"Leaf")),new q(n,i,"mi"))),t.add(["And","Or","Not","Equivalent","Implies"],(n,i)=>(l(g(n,"Children")),new A(n,i,"mrow",this)))}this.nameMap.forEach((t,n)=>{l(this.renderers.get(t),`Renderer for ${n} (ID ${t}) is missing`)})}rendererCollection(e){const t=this;function n(s,o){let d=t.nameMap.get(me(s));if(d===void 0){console.warn(`${me(s)} is missing a name ID, this usually happens when a renderer is defined, but the parser cannot generate it.`);return}l(!t.renderers.has(d),`Renderer for ${d} already exists`),t.renderers.set(d,o)}function i(s){return{add:(o,d)=>{typeof o=="string"&&(o=[o]),o.forEach(u=>{n(s.concat([u]),d)})},rendererCollection(o){return i(s.concat([o]))}}}return i([e])}renderAll(e){const t=this.render(e.value,null);return new nt(t)}render(e,t,n={}){const i=this.renderers.get(e.name);return l(i,`No renderer for "${e.name}"`),i(e,t,n)}}const _t="modulepreload",gt=function(r){return"/aftermath-editor/"+r},ve={},mt=function(e,t,n){if(!t||t.length===0)return e();const i=document.getElementsByTagName("link");return Promise.all(t.map(s=>{if(s=gt(s),s in ve)return;ve[s]=!0;const o=s.endsWith(".css"),d=o?'[rel="stylesheet"]':"";if(!!n)for(let p=i.length-1;p>=0;p--){const v=i[p];if(v.href===s&&(!o||v.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${s}"]${d}`))return;const f=document.createElement("link");if(f.rel=o?"stylesheet":_t,o||(f.as="script",f.crossOrigin=""),f.href=s,document.head.appendChild(f),o)return new Promise((p,v)=>{f.addEventListener("load",p),f.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${s}`)))})})).then(()=>e())},wt={renderRows:!1};function ft(){mt(()=>import("./lil-gui.esm-0f09e890.js"),[]).then(r=>{new r.GUI().add(wt,"renderRows")})}class pt{#e;#t;#n;constructor(){this.#e=z("div",{style:{position:"absolute"}}),this.#t=z("div",{classList:["autocomplete-container"],style:{position:"absolute"}}),this.#e.append(this.#t),this.#n=z("ul",{}),this.#t.append(this.#n),this.setVisibility(!1)}get element(){return this.#e}setVisibility(e){this.#e.style.display=e?"block":"none",this.#t.style.display=e?"block":"none"}setPosition(e){const t=this.#e.getBoundingClientRect();this.#t.style.left=`${e.x-t.left}px`,this.#t.style.top=`${e.y-t.top}px`}setElements(e){this.#n.innerHTML="";for(const t of e){const n=document.createElement("li");n.innerText=t,this.#n.append(n)}this.setVisibility(e.length>0)}}class bt{#e;#t;#n;constructor(){const e=document.createElement("div");e.style.position="absolute";const t=document.createElement("span");t.className="caret",this.#t=t,e.append(t);const n=document.createElement("div");n.style.position="absolute",n.style.top="0px",n.style.left="0px",this.#n=n,e.append(n),this.#e=e}get element(){return this.#e}setPosition(e){const t=this.#e.getBoundingClientRect();this.#t.style.left=`${e.x-t.left}px`,this.#t.style.top=`${e.y-t.top}px`}setHeight(e){e<=0?this.#t.style.display="none":this.#t.style.display="",this.#t.style.height=`${e}px`,this.#t.style.marginTop=`${-e}px`}addSelection(e){const t=this.#e.getBoundingClientRect(),n=z("span",{classList:["caret-selection"],style:{position:"absolute",left:`${e.x-t.left}px`,top:`${e.y-t.top}px`,width:`${e.width}px`,height:`${e.height}px`}});this.#n.append(n)}clearSelections(){this.#n.replaceChildren()}}function Re(r,e){return r in e}class yt{tasks=[];constructor(){}add(e){this.tasks.push(e),setTimeout(()=>{this.run()},0)}run(){for(;this.tasks.length>0;)this.tasks.shift()()}}class Et extends HTMLElement{mathEditor;inputHandler;autocomplete;caretsContainer;syntaxTree;renderer;renderResult;renderTaskQueue=new yt;mathMlElement;constructor(){super();const e=this.attachShadow({mode:"open"}),t=z("span",{style:{display:"inline-block",userSelect:"none",touchAction:"none",cursor:"text"},tabIndex:0});this.mathEditor=new oe(Ve),this.caretsContainer=z("div",{style:{position:"absolute"}}),t.append(this.caretsContainer),this.mathMlElement=document.createElement("math"),t.append(this.mathMlElement);const n=z("span",{style:{position:"absolute"}});this.inputHandler=new tt,n.appendChild(this.inputHandler.element),this.addPointerEventListeners(t,()=>this.inputHandler.focus()),this.addInputEventListeners(),t.addEventListener("focus",()=>this.inputHandler.focus()),this.autocomplete=new pt,n.appendChild(this.autocomplete.element),this.renderer=new ht(new Map(Array.from(k.get_syntax_node_name_map().values,([s,o])=>[me(s),o]))),this.syntaxTree=U.getSyntaxTree(this.mathEditor),this.renderResult=this.renderer.renderAll({errors:null,value:this.syntaxTree});const i=document.createElement("style");i.textContent=`${Qe}
 ${Ye}
 ${Xe}
 ${Ze}`,e.append(i,n,t),this.updateInput()}addInputEventListeners(){this.inputHandler.element.addEventListener("keydown",t=>{t.key==="ArrowUp"?this.mathEditor.move_caret("Up","Char"):t.key==="ArrowDown"?this.mathEditor.move_caret("Down","Char"):t.key==="ArrowLeft"?this.mathEditor.move_caret("Left","Char"):t.key==="ArrowRight"?this.mathEditor.move_caret("Right","Char"):t.code==="KeyZ"&&t.ctrlKey?this.mathEditor.undo():t.code==="KeyY"&&t.ctrlKey&&this.mathEditor.redo(),this.updateInput()}),this.inputHandler.element.addEventListener("beforeinput",t=>{this.renderTaskQueue.add(()=>{if(t.inputType==="deleteContentBackward"||t.inputType==="deleteWordBackward")this.mathEditor.remove_at_caret("Left","Char"),this.updateInput();else if(t.inputType==="deleteContentForward"||t.inputType==="deleteWordForward")this.mathEditor.remove_at_caret("Right","Char"),this.updateInput();else if(t.inputType==="insertText"){const n=t.data;if(n===null)return;const i=se(n);U.insertAtCaret(this.mathEditor,i),this.updateInput()}else t.inputType})});const e=t=>{t.setData("application/json",this.mathEditor.copy("JsonInputTree"))};this.inputHandler.element.addEventListener("copy",t=>{if(t.clipboardData===null){console.error("No clipboard data");return}e(t.clipboardData),t.preventDefault()}),this.inputHandler.element.addEventListener("cut",t=>{if(t.clipboardData===null){console.error("No clipboard data");return}e(t.clipboardData),t.preventDefault(),this.mathEditor.remove_at_caret("Range","Char"),this.updateInput()}),this.inputHandler.element.addEventListener("paste",t=>{if(t.clipboardData===null){console.error("No clipboard data");return}const n=t.clipboardData.getData("application/json");if(n)this.mathEditor.paste(n,"JsonInputTree");else{const i=t.clipboardData.getData("text/plain");this.mathEditor.paste(i,"JsonInputTree")}this.updateInput()})}addPointerEventListeners(e,t){const n=s=>{const o=this.renderResult.getLayoutPosition({x:s.clientX,y:s.clientY});return o?{row_indices:o.indices.indices.slice(),offset:o.offset}:null};let i=!1;e.addEventListener("pointerdown",s=>{if(!s.isPrimary)return;const o=n(s);o&&(e.setPointerCapture(s.pointerId),t(),i=!0,this.mathEditor.start_selection(o,"Char"),this.updateInput())}),e.addEventListener("pointerup",s=>{if(!s.isPrimary)return;i=!1;const o=n(s);o&&this.mathEditor.extend_selection(o),this.mathEditor.finish_selection(),e.releasePointerCapture(s.pointerId),this.renderCarets()}),e.addEventListener("pointercancel",s=>{if(!s.isPrimary)return;i=!1;const o=n(s);o&&this.mathEditor.extend_selection(o),this.mathEditor.finish_selection(),e.releasePointerCapture(s.pointerId),this.renderCarets()}),e.addEventListener("mousedown",s=>{if(!i)return;const o=n(s);if(!o)return;const d=s.detail;d===2?(this.mathEditor.start_selection(o,"Word"),this.renderCarets()):d===3&&(this.mathEditor.start_selection(o,"Line"),this.renderCarets())}),e.addEventListener("pointermove",s=>{if(!s.isPrimary||!i)return;const o=n(s);o&&(this.mathEditor.extend_selection(o),this.renderCarets())})}connectedCallback(){this.attributeChangedCallback("mathml","",this.getAttribute("mathml")??"")}disconnectedCallback(){}attributeChangedCallback(e,t,n){if(e==="mathml"){const i=et(n||"<math></math>");l(i instanceof MathMLElement,"Mathml attribute must be a valid mathml element");const s=Ge(i);s.errors.length>0&&console.warn("Parsed input has errors",s.errors),U.spliceAtRange(this.mathEditor,{row_indices:[],start:this.syntaxTree.range.start,end:this.syntaxTree.range.end},s.root.values),this.updateInput()}else console.log("Attribute changed",e,t,n)}static get observedAttributes(){return["mathml"]}updateInput(){console.log("about to get the syntax tree for",U.getInputTree(this.mathEditor)),this.syntaxTree=U.getSyntaxTree(this.mathEditor),this.renderResult=this.renderer.renderAll({value:this.syntaxTree,errors:null}),console.log("Rendered",this.renderResult);const e=this.renderResult.getElement(N.default()).getElements();for(const t of e)l(t instanceof MathMLElement);this.mathMlElement.replaceChildren(...e),this.renderCarets();for(const t of e)l(t instanceof MathMLElement),t.style.transform="translate(0, 0)",t.style.transform="";this.renderCarets()}renderCarets(){if(!this.isConnected)return;let e=U.getCaret(this.mathEditor);this.caretsContainer.replaceChildren();for(const t of e){const n=new bt;if(this.caretsContainer.append(n.element),Re("Row",t)){const i=t.Row,s=new N(i.row_indices),o=this.renderResult.getViewportSelection({indices:s,start:i.start,end:i.end}),d=i.start<=i.end,u=this.renderResult.getViewportCaretSize(s);n.setPosition({x:o.rect.x+(d?o.rect.width:0),y:o.baseline+u*.1}),n.setHeight(u),n.clearSelections(),i.start===i.end||n.addSelection(o.rect)}else if(Re("Grid",t)){const i=t.Grid,s=new N([...i.row_indices,[i.index,i.range.start]]),o=this.renderResult.getViewportRowBounds(s),d=new N([...i.row_indices,[i.index,Math.max(i.range.end-1,i.range.start)]]),u=this.renderResult.getViewportRowBounds(d);n.clearSelections(),n.addSelection(O.joinRectangles({x:Math.min(o.x,u.x),y:Math.min(o.y,u.y),width:0,height:0},{x:Math.max(o.x+o.width,u.x+u.width),y:Math.max(o.y+o.height,u.y+u.height),width:0,height:0})),n.setHeight(0)}else Ue(t)}}}ft();customElements.define("math-editor",Et);document.querySelectorAll("math[data-editor]").forEach(r=>{const e=document.createElement("math-editor");e.setAttribute("mathml",r.outerHTML),r.replaceWith(e)});console.log("Running version",Be);
